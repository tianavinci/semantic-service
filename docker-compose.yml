services:
  dask-scheduler:
    container_name: dask-scheduler
    build:
      context: ./
    command: ["dask-scheduler", "--host", "0.0.0.0", "--port", "8786", "--dashboard-address", ":8787"]
    ports:
      - "8786:8786"
      - "8787:8787"
    restart: unless-stopped

  dask-worker:
    build:
      context: ./
    command: ["dask-worker", "tcp://dask-scheduler:8786", "--nthreads", "2", "--memory-limit", "2GB"]
    depends_on:
      - dask-scheduler
    restart: unless-stopped

  api:
    container_name: semantic-api
    build:
      context: ./
    environment:
      # Use Postgres running on the host machine. Port 5433 on the host maps to the host Postgres.
      # Removed the timeout query parameter because some asyncpg/asyncio combinations can treat it as a string
      # and cause a TypeError when used with asyncio.timeouts. DB wait timeout is controlled via DB_WAIT_TIMEOUT.
      DATABASE_URL: "postgresql+asyncpg://lextr_user:Mygooru1028%24@host.docker.internal:5433/lextr?sslmode=disable"

      # Use host Redis running on the host machine
      REDIS_URL: "redis://host.docker.internal:6379/0"

      # Fallback host IP (your Windows host IPv4) â€” used by scripts/wait_for_db.py
      DOCKER_HOST_IP: "172.19.208.1"
      # Increase wait timeout so the container retries longer (seconds)
      DB_WAIT_TIMEOUT: "300"
      DB_WAIT_INTERVAL: "1"

      SEMANTIC_NAMESPACE_DEFAULT: default
      SEMANTIC_VERSION: v0.1.0
      ENABLE_CACHE: "false"
      DASK_MODE: "remote"
      DASK_SCHEDULER_ADDRESS: "tcp://dask-scheduler:8786"
      DASK_LOCAL_THREADS: "0"
      UVICORN_WORKERS: "4"
    # Ensure the api container can resolve host.docker.internal to the host gateway.
    # Map to the Windows host IP that is reachable from your other working compose (change if yours differs).
    extra_hosts:
      - "host.docker.internal:172.19.208.1"  # update if your host IP differs
    ports:
      - "8080:8080"
    depends_on:
      - dask-scheduler
    restart: unless-stopped

# Note: local db/redis services removed as requested; the API will connect to services running on the host.
